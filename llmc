#!/bin/bash
# llmc - Unified LLM Commander Living Template System Interface
# The one command that rules them all!

set -euo pipefail

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
MAGENTA='\033[0;35m'
NC='\033[0m' # No Color

# Logging functions
log_info() { echo -e "${BLUE}‚ÑπÔ∏è  [$(date +'%H:%M:%S')]${NC} $1"; }
log_success() { echo -e "${GREEN}‚úÖ $1${NC}"; }
log_warning() { echo -e "${YELLOW}‚ö†Ô∏è  $1${NC}"; }
log_error() { echo -e "${RED}‚ùå $1${NC}"; }
log_title() { echo -e "${CYAN}$1${NC}"; }

# Better input handling with single key support
get_single_key() {
    local -n result_ref=$1
    local prompt="$2"
    
    # Show prompt
    echo -n "$prompt"
    
    # Read single character without needing Enter
    read -r -n 1 key
    
    # Clear the line
    echo ""
    
    result_ref="$key"
}

# Signal handling for clean exit
trap 'echo -e "\n${RED}üëã Goodbye!${NC}"; exit 0' INT

# Detect if we're in an LLM Commander environment
detect_llmc_context() {
    local current_dir=$(pwd)
    local script_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
    
    # Check if we're in a deployed llmc subdirectory
    if [[ "$current_dir" == *"/llmc" ]]; then
        echo "deployed"
    elif [[ "$current_dir" == "$script_dir" ]]; then
        echo "source"
    else
        echo "external"
    fi
}

# Show main TUI menu
show_main_menu() {
    clear
    echo -e "${CYAN}‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó${NC}"
    echo -e "${CYAN}‚ïë${NC}  üöÄ ${GREEN}LLM Commander - Living Template System${NC}              ${CYAN}‚ïë${NC}"
    echo -e "${CYAN}‚ïë${NC}  üåü Deploy LLM Commander "magic" to any project               ${CYAN}‚ïë${NC}"
    echo -e "${CYAN}‚ïë${NC}  üî• Single-key input ‚Ä¢ Ctrl+C to exit                      ${CYAN}‚ïë${NC}"
    echo -e "${CYAN}‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£${NC}"
    echo -e "${CYAN}‚ïë${NC}  ${GREEN}1. üíª Development Mode${NC}                                     ${CYAN}‚ïë${NC}"
    echo -e "${CYAN}‚ïë${NC}       Use LLM Commander in this project                      ${CYAN}‚ïë${NC}"
    echo -e "${CYAN}‚ïë${NC}  ${GREEN}2. üì¶ Extract Template${NC}                                     ${CYAN}‚ïë${NC}"
    echo -e "${CYAN}‚ïë${NC}       Create portable version for deployment                ${CYAN}‚ïë${NC}"
    echo -e "${CYAN}‚ïë${NC}  ${GREEN}3. ‚öôÔ∏è  Smart Setup & Configure${NC}                            ${CYAN}‚ïë${NC}"
    echo -e "${CYAN}‚ïë${NC}       Configure paths, scripts, and environment             ${CYAN}‚ïë${NC}"
    echo -e "${CYAN}‚ïë${NC}  ${GREEN}4. üöÄ Deploy to Project${NC}                                     ${CYAN}‚ïë${NC}"
    echo -e "${CYAN}‚ïë${NC}       Install to another repository                         ${CYAN}‚ïë${NC}"
    echo -e "${CYAN}‚ïë${NC}  ${GREEN}5. ‚úÖ Test Deployment${NC}                                       ${CYAN}‚ïë${NC}"
    echo -e "${CYAN}‚ïë${NC}       Verify installation and test functionality            ${CYAN}‚ïë${NC}"
    echo -e "${CYAN}‚ïë${NC}  ${GREEN}6. üìä View Configuration${NC}                                    ${CYAN}‚ïë${NC}"
    echo -e "${CYAN}‚ïë${NC}       Show current settings and status                      ${CYAN}‚ïë${NC}"
    echo -e "${CYAN}‚ïë${NC}  ${YELLOW}7. üîß Advanced Setup${NC}                                        ${CYAN}‚ïë${NC}"
    echo -e "${CYAN}‚ïë${NC}       API keys, custom paths, advanced options             ${CYAN}‚ïë${NC}"
    echo -e "${CYAN}‚ïë${NC}  ${YELLOW}8. üíæ Backup/Restore${NC}                                       ${CYAN}‚ïë${NC}"
    echo -e "${CYAN}‚ïë${NC}       Manage templates and configurations                  ${CYAN}‚ïë${NC}"
    echo -e "${CYAN}‚ïë${NC}  ${YELLOW}9. üìö Documentation${NC}                                        ${CYAN}‚ïë${NC}"
    echo -e "${CYAN}‚ïë${NC}       Help, guides, and troubleshooting                    ${CYAN}‚ïë${NC}"
    echo -e "${CYAN}‚ïë${NC}  ${RED}0. üö™ Exit${NC}                                                ${CYAN}‚ïë${NC}"
    echo -e "${CYAN}‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù${NC}"
    echo ""
    echo -e "${YELLOW}üí° Press any number key (0-9) to select ‚Ä¢ Ctrl+C to exit${NC}"
    echo ""
}

# Development mode - use LLM Commander in current project
development_mode() {
    log_title "üíª Development Mode"
    echo "Enabling LLM Commander in current project..."
    
    local context=$(detect_llmc_context)
    
    case $context in
        "source")
            log_success "Detected source LLM Commander installation"
            echo "‚úÖ All LLM Commander features are available here!"
            ;;
        "deployed")
            log_success "Detected deployed LLM Commander installation"
            echo "‚úÖ LLM Commander is deployed and ready to use!"
            ;;
        *)
            log_warning "Not in an LLM Commander directory"
            echo "üìù Available scripts:"
            echo "   ./llmc/scripts/claude_wrap.sh 'message'"
            echo "   ./llmc/scripts/tool_health.sh"
            echo "   ./llmc/scripts/rag_refresh.sh"
            ;;
    esac
    
    echo ""
    echo "üéØ Quick test commands:"
    echo "   ./llmc/scripts/claude_wrap.sh 'Hello, world!'"
    echo "   ./llmc/scripts/tool_health.sh"
    echo "   ./llmc/scripts/tool_query.py 'What tools are available?'"
    echo ""
    echo -e "${YELLOW}Press any key to continue...${NC}"
    read -r -n 1
}

# Extract template
extract_template() {
    log_title "üì¶ Extract Template"
    echo "Creating portable template from LLM Commander..."
    
    # Check if extract script exists
    if [[ ! -f "scripts/extract_template.py" ]]; then
        log_error "extract_template.py not found!"
        echo "üí° Make sure you're in the LLM Commander source directory"
        echo -e "${YELLOW}Press any key to continue...${NC}"
        read -r -n 1
        return
    fi
    
    echo ""
    read -p "Output directory (default: llmc_template): " output_dir
    output_dir=${output_dir:-llmc_template}
    
    echo "Extracting template to: $output_dir"
    
    # Run extraction
    python3 scripts/extract_template.py --output "$output_dir"
    
    if [[ $? -eq 0 ]]; then
        log_success "Template extraction completed!"
        echo "üìÇ Template created in: $(pwd)/$output_dir"
        echo "üìã Next steps:"
        echo "   1. Run option 3: Smart Setup & Configure"
        echo "   2. Run option 4: Deploy to Project"
    else
        log_error "Template extraction failed!"
    fi
    
    echo -e "${YELLOW}Press any key to continue...${NC}"
    read -r -n 1
}

# Smart setup and configuration
smart_setup() {
    log_title "‚öôÔ∏è  Smart Setup & Configure"
    echo "Configuring LLM Commander for optimal deployment..."
    
    local template_dir="llmc_template"
    
    # Check if template exists
    if [[ ! -d "$template_dir" ]]; then
        log_error "Template directory '$template_dir' not found!"
        echo "üí° Run option 2: Extract Template first"
        echo -e "${YELLOW}Press any key to continue...${NC}"
        read -r -n 1
        return
    fi
    
    cd "$template_dir"
    
    # Create smart setup script if it doesn't exist
    if [[ ! -f "setup.sh" ]]; then
        echo "Creating smart setup configuration..."
        
        # Create setup.sh script
        cat > setup.sh << 'EOF'
#!/bin/bash
# Smart LLM Commander Setup
set -euo pipefail

# Colors
RED='\033[0;31m'; GREEN='\033[0;32m'; YELLOW='\033[1;33m'; BLUE='\033[0;34m'; NC='\033[0m'
log_info() { echo -e "${BLUE}‚ÑπÔ∏è  [$(date +'%H:%M:%S')]${NC} $1"; }
log_success() { echo -e "${GREEN}‚úÖ $1${NC}"; }

# Detect context
REPO_ROOT=$(git rev-parse --show-toplevel 2>/dev/null || pwd)
LLMC_ROOT=$(pwd)
CURRENT_DIR=$(pwd)

if [[ "$CURRENT_DIR" == *"/$REPO_ROOT/llmc" ]]; then
    DEPLOYMENT_MODE="production"
    LLMC_INSTALL_ROOT="$CURRENT_DIR"
elif [[ "$REPO_ROOT" == "$LLMC_ROOT" ]]; then
    DEPLOYMENT_MODE="development"
    LLMC_INSTALL_ROOT="$CURRENT_DIR"
else
    DEPLOYMENT_MODE="unknown"
    LLMC_INSTALL_ROOT="$CURRENT_DIR"
fi

log_info "Deployment Mode: $DEPLOYMENT_MODE"
log_info "Repo Root: $REPO_ROOT"
log_info "LLMC Root: $LLMC_ROOT"

# Create environment file
cat > .llmc_env.sh << 'ENVEOF'
#!/bin/bash
export REPO_ROOT="'$REPO_ROOT'"
export LLMC_ROOT="'$LLMC_ROOT'"
export LLMC_INSTALL_ROOT="'$LLMC_INSTALL_ROOT'"
export DEPLOYMENT_MODE="'$DEPLOYMENT_MODE'"

if [[ "$DEPLOYMENT_MODE" == "production" ]]; then
    export LLMC_CONFIG_PATH="$LLMC_ROOT/../llmc.toml"
    export LLMC_TOOLS_PATH="$LLMC_ROOT/../tools"
else
    export LLMC_CONFIG_PATH="$REPO_ROOT/llmc.toml"
    export LLMC_TOOLS_PATH="$REPO_ROOT/tools"
fi
ENVEOF

# Make scripts executable
find . -name "*.sh" -type f -exec chmod +x {} \;
find . -name "*.py" -type f -exec grep -l "^#!/usr/bin/env python" {} \; -exec chmod +x {} \;
chmod +x deploy.py 2>/dev/null || true

log_success "Smart setup completed!"
echo "Ready to deploy with: python3 deploy.py [target_directory]"
EOF
        
        chmod +x setup.sh
    fi
    
    # Run the setup
    ./setup.sh
    
    cd - >/dev/null
    
    log_success "Smart setup completed!"
    echo "üéØ Template is ready for deployment!"
    echo -e "${YELLOW}Press any key to continue...${NC}"
    read -r -n 1
}

# Deploy to project
deploy_to_project() {
    log_title "üöÄ Deploy to Project"
    echo "Deploying LLM Commander to target project..."
    
    local template_dir="llmc_template"
    
    if [[ ! -d "$template_dir" ]]; then
        log_error "Template directory '$template_dir' not found!"
        echo "üí° Run option 2: Extract Template and option 3: Smart Setup first"
        echo -e "${YELLOW}Press any key to continue...${NC}"
        read -r -n 1
        return
    fi
    
    echo ""
    read -p "Target project directory: " target_dir
    if [[ -z "$target_dir" ]]; then
        log_error "No target directory specified!"
        echo -e "${YELLOW}Press any key to continue...${NC}"
        read -r -n 1
        return
    fi
    
    if [[ ! -d "$target_dir" ]]; then
        echo ""
        read -p "Target directory doesn't exist. Create it? (y/N): " create_dir
        if [[ "$create_dir" =~ ^[Yy]$ ]]; then
            mkdir -p "$target_dir"
            log_success "Created target directory: $target_dir"
        else
            log_warning "Deployment cancelled"
            echo -e "${YELLOW}Press any key to continue...${NC}"
            read -r -n 1
            return
        fi
    fi
    
    echo "Deploying from $template_dir to $target_dir..."
    
    cd "$template_dir"
    
    # Check for deploy script
    if [[ -f "deploy.py" ]]; then
        python3 deploy.py "$target_dir"
    else
        # Manual deployment
        mkdir -p "$target_dir/llmc"
        cp -r . "$target_dir/llmc/"
        
        # Fix paths in deployed scripts
        find "$target_dir/llmc/scripts" -name "*.sh" -type f -exec sed -i \
            's|llmc\.toml|../llmc.toml|g' {} \; 2>/dev/null || true
    fi
    
    cd - >/dev/null
    
    log_success "Deployment completed!"
    echo "üéâ LLM Commander deployed to: $target_dir/llmc/"
    echo "üìã Test commands:"
    echo "   cd $target_dir"
    echo "   ./llmc/scripts/claude_wrap.sh 'Hello world!'"
    echo -e "${YELLOW}Press any key to continue...${NC}"
    read -r -n 1
}

# Test deployment
test_deployment() {
    log_title "‚úÖ Test Deployment"
    echo "Testing LLM Commander deployment..."
    
    # Look for deployed llmc directory
    if [[ -d "llmc" ]]; then
        log_success "Found deployed llmc directory!"
        echo "üß™ Running tests..."
        
        echo ""
        echo "Test 1: Script permissions"
        if [[ -x "llmc/scripts/claude_wrap.sh" ]]; then
            log_success "‚úÖ claude_wrap.sh is executable"
        else
            log_warning "‚ö†Ô∏è  claude_wrap.sh needs executable permission"
        fi
        
        echo ""
        echo "Test 2: Configuration files"
        if [[ -f "llmc/llmc.toml" ]]; then
            log_success "‚úÖ llmc.toml found"
        else
            log_warning "‚ö†Ô∏è  llmc.toml not found"
        fi
        
        echo ""
        echo "Test 3: Environment setup"
        if [[ -f "llmc/.llmc_env.sh" ]]; then
            log_success "‚úÖ Environment configuration found"
            source llmc/.llmc_env.sh
            echo "   Config path: $LLMC_CONFIG_PATH"
        else
            log_warning "‚ö†Ô∏è  Environment configuration missing"
        fi
        
        echo ""
        echo "üéØ Quick test command:"
        echo "   ./llmc/scripts/claude_wrap.sh 'This is a test message'"
        
    else
        log_error "No deployed llmc directory found!"
        echo "üí° Deploy first using option 4: Deploy to Project"
    fi
    
    echo -e "${YELLOW}Press any key to continue...${NC}"
    read -r -n 1
}

# View configuration
view_configuration() {
    log_title "üìä View Configuration"
    echo "Current LLM Commander configuration..."
    
    local context=$(detect_llmc_context)
    echo "Context: $context"
    echo ""
    
    case $context in
        "source")
            echo "üìÅ Source LLM Commander Installation"
            echo "   Directory: $(pwd)"
            echo "   Scripts: $(find scripts -name "*.sh" | wc -l) shell scripts"
            echo "   Tools: $(find tools -type f | wc -l) tool files"
            ;;
        "deployed")
            echo "üìÅ Deployed LLM Commander Installation"
            echo "   Directory: $(pwd)"
            echo "   Scripts: $(find scripts -name "*.sh" | wc -l) shell scripts"
            echo "   Environment: $([[ -f ".llmc_env.sh" ]] && echo "‚úÖ Configured" || echo "‚ùå Missing")"
            ;;
        *)
            echo "üìÅ External Project"
            echo "   Directory: $(pwd)"
            if [[ -d "llmc" ]]; then
                echo "   Deployed LLM Commander: ‚úÖ Found"
                echo "   Scripts: $(find llmc/scripts -name "*.sh" 2>/dev/null | wc -l) shell scripts"
            else
                echo "   Deployed LLM Commander: ‚ùå Not found"
            fi
            ;;
    esac
    
    echo ""
    if [[ -f ".llmc_env.sh" ]]; then
        echo "üîß Environment Variables:"
        source .llmc_env.sh
        echo "   REPO_ROOT: $REPO_ROOT"
        echo "   LLMC_ROOT: $LLMC_ROOT"
        echo "   DEPLOYMENT_MODE: $DEPLOYMENT_MODE"
        echo "   LLMC_CONFIG_PATH: $LLMC_CONFIG_PATH"
    fi
    
    echo -e "${YELLOW}Press any key to continue...${NC}"
    read -r -n 1
}

# Advanced setup (placeholder)
advanced_setup() {
    log_title "üîß Advanced Setup"
    echo "Advanced configuration options..."
    echo ""
    echo "üí° Coming Soon:"
    echo "   ‚Ä¢ API key management"
    echo "   ‚Ä¢ Custom path configurations"
    echo "   ‚Ä¢ RAG system setup"
    echo "   ‚Ä¢ Agent configurations"
    echo "   ‚Ä¢ Environment profiles"
    echo ""
    echo "üõ†Ô∏è  Current capabilities:"
    echo "   ‚Ä¢ Automatic path resolution"
    echo "   ‚Ä¢ Development/production mode detection"
    echo "   ‚Ä¢ Smart script configuration"
    
    echo -e "${YELLOW}Press any key to continue...${NC}"
    read -r -n 1
}

# Backup/Restore (placeholder)
backup_restore() {
    log_title "üíæ Backup/Restore"
    echo "Template and configuration management..."
    echo ""
    echo "üí° Coming Soon:"
    echo "   ‚Ä¢ Template versioning"
    echo "   ‚Ä¢ Configuration backups"
    echo "   ‚Ä¢ Restore points"
    echo "   ‚Ä¢ Template library"
    echo ""
    echo "üõ†Ô∏è  Manual options:"
    echo "   ‚Ä¢ Copy llmc_template/ for backup"
    echo "   ‚Ä¢ Archive configurations"
    echo "   ‚Ä¢ Document customizations"
    
    echo -e "${YELLOW}Press any key to continue...${NC}"
    read -r -n 1
}

# Documentation
show_documentation() {
    log_title "üìö Documentation"
    echo "LLM Commander Living Template System"
    echo ""
    echo "üéØ Quick Start:"
    echo "   1. Development: Use LLM Commander in current project"
    echo "   2. Extract Template: Create portable version"
    echo "   3. Smart Setup: Configure for deployment"
    echo "   4. Deploy: Install to target project"
    echo "   5. Test: Verify functionality"
    echo ""
    echo "üîß Key Features:"
    echo "   ‚Ä¢ Automatic path resolution"
    echo "   ‚Ä¢ Development/Production mode detection"
    echo "   ‚Ä¢ Smart script configuration"
    echo "   ‚Ä¢ Template extraction and deployment"
    echo "   ‚Ä¢ Environment management"
    echo ""
    echo "üìñ Documentation Files:"
    echo "   ‚Ä¢ LIVING_TEMPLATE_GUIDE.md"
    echo "   ‚Ä¢ docs/llmc_folder_structure.md"
    echo "   ‚Ä¢ docs/template_extraction_plan.md"
    echo ""
    echo "üÜò Troubleshooting:"
    echo "   ‚Ä¢ Check scripts are executable"
    echo "   ‚Ä¢ Verify configuration files exist"
    echo "   ‚Ä¢ Run setup.sh in template directory"
    echo "   ‚Ä¢ Test with claude_wrap.sh"
    
    echo -e "${YELLOW}Press any key to continue...${NC}"
    read -r -n 1
}

# Main application loop with improved input handling
main() {
    while true; do
        show_main_menu
        
        # Get single key input
        local choice=""
        get_single_key choice "Select option (0-9): "
        
        case $choice in
            1) development_mode ;;
            2) extract_template ;;
            3) smart_setup ;;
            4) deploy_to_project ;;
            5) test_deployment ;;
            6) view_configuration ;;
            7) advanced_setup ;;
            8) backup_restore ;;
            9) show_documentation ;;
            0) 
                echo ""
                log_success "Thanks for using LLM Commander! üöÄ"
                echo "üëã See you next time!"
                exit 0
                ;;
            *)
                echo ""
                log_error "Invalid option: '$choice'"
                echo "Please select 0-9"
                sleep 1
                ;;
        esac
    done
}

# Initialize
echo "üöÄ Starting LLM Commander Living Template System..."
sleep 1

# Run main application
main