============================= test session starts ==============================
platform linux -- Python 3.12.3, pytest-9.0.1, pluggy-1.6.0
rootdir: /home/vmlinux/src/llmc
configfile: pyproject.toml
plugins: Faker-39.0.0, langsmith-0.4.46, anyio-4.12.0, respx-0.22.0, timeout-2.4.0, asyncio-1.3.0, requests-mock-1.12.1, cov-7.0.0
asyncio: mode=Mode.STRICT, debug=False, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collected 4 items

tests/agent/test_openai_compat_backend.py .FFF                           [100%]

=================================== FAILURES ===================================
_____________________________ test_generate_errors _____________________________

backend = <llmc_agent.backends.openai_compat.OpenAICompatBackend object at 0x78db32b49670>
generate_request = GenerateRequest(messages=[{'role': 'user', 'content': 'Hello'}], system='System prompt', model='test-model', temperature=0.7, max_tokens=1024)

    @pytest.mark.asyncio
    @respx.mock
    async def test_generate_errors(backend, generate_request):
        # Test Case 1: 401 Unauthorized
        respx.post("http://localhost:8080/v1/chat/completions").mock(return_value=httpx.Response(401))
        with pytest.raises(AuthenticationError):
>           await backend.generate(generate_request)

/home/vmlinux/src/llmc/tests/agent/test_openai_compat_backend.py:112: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/home/vmlinux/src/llmc/llmc_agent/backends/openai_compat.py:76: in generate
    response.raise_for_status()
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <Response [401 Unauthorized]>

    def raise_for_status(self) -> Response:
        """
        Raise the `HTTPStatusError` if one occurred.
        """
        request = self._request
        if request is None:
            raise RuntimeError(
                "Cannot call `raise_for_status` as the request "
                "instance has not been set on this response."
            )
    
        if self.is_success:
            return self
    
        if self.has_redirect_location:
            message = (
                "{error_type} '{0.status_code} {0.reason_phrase}' for url '{0.url}'\n"
                "Redirect location: '{0.headers[location]}'\n"
                "For more information check: https://developer.mozilla.org/en-US/docs/Web/HTTP/Status/{0.status_code}"
            )
        else:
            message = (
                "{error_type} '{0.status_code} {0.reason_phrase}' for url '{0.url}'\n"
                "For more information check: https://developer.mozilla.org/en-US/docs/Web/HTTP/Status/{0.status_code}"
            )
    
        status_class = self.status_code // 100
        error_types = {
            1: "Informational response",
            3: "Redirect response",
            4: "Client error",
            5: "Server error",
        }
        error_type = error_types.get(status_class, "Invalid status code")
        message = message.format(self, error_type=error_type)
>       raise HTTPStatusError(message, request=request, response=self)
E       httpx.HTTPStatusError: Client error '401 Unauthorized' for url 'http://localhost:8080/v1/chat/completions'
E       For more information check: https://developer.mozilla.org/en-US/docs/Web/HTTP/Status/401

/home/vmlinux/.local/lib/python3.12/site-packages/httpx/_models.py:829: HTTPStatusError
_________________________ test_generate_stream_errors __________________________

backend = <llmc_agent.backends.openai_compat.OpenAICompatBackend object at 0x78db32bbb830>
generate_request = GenerateRequest(messages=[{'role': 'user', 'content': 'Hello'}], system='System prompt', model='test-model', temperature=0.7, max_tokens=1024)

    @pytest.mark.asyncio
    @respx.mock
    async def test_generate_stream_errors(backend, generate_request):
        # Test Case 1: 401 Unauthorized
        respx.post("http://localhost:8080/v1/chat/completions").mock(return_value=httpx.Response(401))
        with pytest.raises(AuthenticationError):
>           async for _ in backend.generate_stream(generate_request):

/home/vmlinux/src/llmc/tests/agent/test_openai_compat_backend.py:135: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/home/vmlinux/src/llmc/llmc_agent/backends/openai_compat.py:115: in generate_stream
    response.raise_for_status()
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <Response [401 Unauthorized]>

    def raise_for_status(self) -> Response:
        """
        Raise the `HTTPStatusError` if one occurred.
        """
        request = self._request
        if request is None:
            raise RuntimeError(
                "Cannot call `raise_for_status` as the request "
                "instance has not been set on this response."
            )
    
        if self.is_success:
            return self
    
        if self.has_redirect_location:
            message = (
                "{error_type} '{0.status_code} {0.reason_phrase}' for url '{0.url}'\n"
                "Redirect location: '{0.headers[location]}'\n"
                "For more information check: https://developer.mozilla.org/en-US/docs/Web/HTTP/Status/{0.status_code}"
            )
        else:
            message = (
                "{error_type} '{0.status_code} {0.reason_phrase}' for url '{0.url}'\n"
                "For more information check: https://developer.mozilla.org/en-US/docs/Web/HTTP/Status/{0.status_code}"
            )
    
        status_class = self.status_code // 100
        error_types = {
            1: "Informational response",
            3: "Redirect response",
            4: "Client error",
            5: "Server error",
        }
        error_type = error_types.get(status_class, "Invalid status code")
        message = message.format(self, error_type=error_type)
>       raise HTTPStatusError(message, request=request, response=self)
E       httpx.HTTPStatusError: Client error '401 Unauthorized' for url 'http://localhost:8080/v1/chat/completions'
E       For more information check: https://developer.mozilla.org/en-US/docs/Web/HTTP/Status/401

/home/vmlinux/.local/lib/python3.12/site-packages/httpx/_models.py:829: HTTPStatusError
_______________________ test_generate_with_tools_errors ________________________

backend = <llmc_agent.backends.openai_compat.OpenAICompatBackend object at 0x78db3253e7b0>
generate_request = GenerateRequest(messages=[{'role': 'user', 'content': 'Hello'}], system='System prompt', model='test-model', temperature=0.7, max_tokens=1024)

    @pytest.mark.asyncio
    @respx.mock
    async def test_generate_with_tools_errors(backend, generate_request):
        tools = [{
            "type": "function",
            "function": {
                "name": "test_tool",
                "description": "A test tool",
                "parameters": {"type": "object", "properties": {}}
            }
        }]
    
        # Test Case 1: 401 Unauthorized
        respx.post("http://localhost:8080/v1/chat/completions").mock(return_value=httpx.Response(401))
        with pytest.raises(AuthenticationError):
>           await backend.generate_with_tools(generate_request, tools)

/home/vmlinux/src/llmc/tests/agent/test_openai_compat_backend.py:171: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/home/vmlinux/src/llmc/llmc_agent/backends/openai_compat.py:169: in generate_with_tools
    response.raise_for_status()
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <Response [401 Unauthorized]>

    def raise_for_status(self) -> Response:
        """
        Raise the `HTTPStatusError` if one occurred.
        """
        request = self._request
        if request is None:
            raise RuntimeError(
                "Cannot call `raise_for_status` as the request "
                "instance has not been set on this response."
            )
    
        if self.is_success:
            return self
    
        if self.has_redirect_location:
            message = (
                "{error_type} '{0.status_code} {0.reason_phrase}' for url '{0.url}'\n"
                "Redirect location: '{0.headers[location]}'\n"
                "For more information check: https://developer.mozilla.org/en-US/docs/Web/HTTP/Status/{0.status_code}"
            )
        else:
            message = (
                "{error_type} '{0.status_code} {0.reason_phrase}' for url '{0.url}'\n"
                "For more information check: https://developer.mozilla.org/en-US/docs/Web/HTTP/Status/{0.status_code}"
            )
    
        status_class = self.status_code // 100
        error_types = {
            1: "Informational response",
            3: "Redirect response",
            4: "Client error",
            5: "Server error",
        }
        error_type = error_types.get(status_class, "Invalid status code")
        message = message.format(self, error_type=error_type)
>       raise HTTPStatusError(message, request=request, response=self)
E       httpx.HTTPStatusError: Client error '401 Unauthorized' for url 'http://localhost:8080/v1/chat/completions'
E       For more information check: https://developer.mozilla.org/en-US/docs/Web/HTTP/Status/401

/home/vmlinux/.local/lib/python3.12/site-packages/httpx/_models.py:829: HTTPStatusError
=========================== short test summary info ============================
FAILED tests/agent/test_openai_compat_backend.py::test_generate_errors - http...
FAILED tests/agent/test_openai_compat_backend.py::test_generate_stream_errors
FAILED tests/agent/test_openai_compat_backend.py::test_generate_with_tools_errors
========================= 3 failed, 1 passed in 1.06s ==========================
