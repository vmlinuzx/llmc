#!/usr/bin/env python3
"""ragx: CLI wrapper that loads llmc.toml and execs `rag` with env vars set.

Usage:
  scripts/ragx <rag-args...>

This does not modify your engine. It sets well-known env vars based on
llmc.toml and then replaces the process with `rag`.
"""
from __future__ import annotations

import os
import sys
import shutil


def apply_toml_to_env() -> None:
    path = "llmc.toml"
    if not os.path.exists(path):
        return
    try:
        import tomllib  # Python 3.11+
        with open(path, "rb") as f:
            cfg = tomllib.load(f)
    except Exception:
        return

    mappings = {
        ("embeddings", "preset"): "EMBEDDINGS_MODEL_PRESET",
        ("embeddings", "model"): "EMBEDDINGS_MODEL_NAME",
        ("storage", "index_path"): "LLMC_RAG_INDEX_PATH",
        ("enrichment", "enabled"): "ENRICHMENT_ENABLED",
        ("enrichment", "model"): "ENRICHMENT_MODEL",
        ("enrichment", "batch_size"): "ENRICHMENT_BATCH_SIZE",
    }
    for (section, key), env_name in mappings.items():
        if env_name in os.environ:
            continue
        val = cfg.get(section, {}).get(key)
        if val is None:
            continue
        if isinstance(val, bool):
            os.environ[env_name] = "1" if val else "0"
        else:
            os.environ[env_name] = str(val)


def main() -> None:
    rag = shutil.which("rag")
    if not rag:
        print("ragx error: `rag` not found on PATH. Did you install the package?", file=sys.stderr)
        sys.exit(127)
    apply_toml_to_env()
    os.execvp(rag, ["rag", *sys.argv[1:]])


if __name__ == "__main__":
    main()

