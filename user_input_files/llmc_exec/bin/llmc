#!/usr/bin/env bash
set -euo pipefail

EXEC_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
REPO_DEFAULT="${LLMC_TARGET_REPO:-$PWD}"
SCRIPTS_DIR="$EXEC_ROOT/../scripts"

usage() {
  cat <<'EOF'
Usage: llmc [--repo PATH] <command> [args...]

Commands:
  codex [args...]     Run codex_wrap.sh against the target repo.
  refresh [options]   Trigger rag_refresh_cron.sh once (locks + ingest).
  rag-refresh [opts]  Alias for refresh.
  rag-sync PATH...    Call rag_sync.sh on specific files relative to repo.
  ingest [--dry-run]  Move research notes from research/incoming/.
  gateway [args...]   Invoke llm_gateway.sh directly.

Environment:
  LLMC_TARGET_REPO    Overrides default repo path (otherwise current directory).
  LLMC_EXEC_ROOT      Set automatically to the toolkit root.
EOF
}

if [ ! -d "$SCRIPTS_DIR" ]; then
  echo "error: unable to locate scripts directory at $SCRIPTS_DIR" >&2
  exit 2
fi

REPO_ROOT="$REPO_DEFAULT"

while (($#)); do
  case "$1" in
    --repo)
      if [ $# -lt 2 ]; then
        echo "error: --repo requires a path argument" >&2
        exit 2
      fi
      REPO_ROOT="$(realpath "$2")"
      shift 2
      ;;
    --repo=*)
      REPO_ROOT="$(realpath "${1#*=}")"
      shift 1
      ;;
    -h|--help)
      usage
      exit 0
      ;;
    --)
      shift
      break
      ;;
    -*)
      echo "error: unknown option: $1" >&2
      usage >&2
      exit 2
      ;;
    *)
      break
      ;;
  esac
done

if [ $# -lt 1 ]; then
  usage >&2
  exit 2
fi

COMMAND="$1"
shift

if [ ! -d "$REPO_ROOT" ]; then
  echo "error: target repo not found: $REPO_ROOT" >&2
  exit 2
fi

export LLMC_EXEC_ROOT="$EXEC_ROOT/.."
export LLMC_TARGET_REPO="$REPO_ROOT"

case "$COMMAND" in
  codex)
    exec "$SCRIPTS_DIR/codex_wrap.sh" --repo "$REPO_ROOT" "$@"
    ;;
  refresh|rag-refresh)
    exec "$SCRIPTS_DIR/rag_refresh_cron.sh" --repo "$REPO_ROOT" "$@"
    ;;
  rag-sync|sync)
    if [ $# -lt 1 ]; then
      echo "error: rag-sync requires at least one path" >&2
      exit 2
    fi
    exec "$SCRIPTS_DIR/rag_sync.sh" --repo "$REPO_ROOT" "$@"
    ;;
  ingest)
    exec "$SCRIPTS_DIR/deep_research_ingest.sh" --repo "$REPO_ROOT" "$@"
    ;;
  gateway)
    exec "$SCRIPTS_DIR/llm_gateway.sh" --repo "$REPO_ROOT" "$@"
    ;;
  *)
    echo "error: unknown command: $COMMAND" >&2
    usage >&2
    exit 2
    ;;
esac
