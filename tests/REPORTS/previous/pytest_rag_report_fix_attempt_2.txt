.............ss.......................................F................. [ 58%]
....................................................                     [100%]
=================================== FAILURES ===================================
________________________ test_index_repo_domain_logging ________________________

mock_get_default_domain = <MagicMock name='get_default_domain' id='139790471064096'>
mock_get_path_overrides = <MagicMock name='get_path_overrides' id='139790471062656'>
mock_resolve_spans = <MagicMock name='resolve_spans_export_path' id='139790524159360'>
mock_index_path = <MagicMock name='index_path_for_write' id='139789132085008'>
mock_ensure_storage = <MagicMock name='ensure_storage' id='139789132077088'>
mock_build_record = <MagicMock name='build_file_record' id='139789132077664'>
mock_populate_hashes = <MagicMock name='populate_span_hashes' id='139789132072192'>
mock_extract_spans = <MagicMock name='extract_spans' id='139790524016848'>
mock_classify = <MagicMock name='classify_slice' id='139789132694256'>
mock_db = <MagicMock name='Database' id='139789132698048'>
mock_find_root = <MagicMock name='find_repo_root' id='139789132701840'>
mock_iter_files = <MagicMock name='iter_source_files' id='139789132705776'>
capsys = <_pytest.capture.CaptureFixture object at 0x7f23815ef8f0>
caplog = <_pytest.logging.LogCaptureFixture object at 0x7f23815efa10>

    @patch("llmc.rag.indexer.iter_source_files")
    @patch("llmc.rag.indexer.find_repo_root")
    @patch("llmc.rag.indexer.Database")
    @patch("llmc.rag.indexer.classify_slice")
    @patch("llmc.rag.indexer.extract_spans")
    @patch("llmc.rag.indexer.populate_span_hashes")
    @patch("llmc.rag.indexer.build_file_record")
    @patch("llmc.rag.indexer.ensure_storage")
    @patch("llmc.rag.indexer.index_path_for_write")
    @patch("llmc.rag.indexer.resolve_spans_export_path")
    @patch("llmc.rag.config.get_path_overrides")
    @patch("llmc.rag.config.get_default_domain")
    def test_index_repo_domain_logging(
        mock_get_default_domain,
        mock_get_path_overrides,
        mock_resolve_spans,
        mock_index_path,
        mock_ensure_storage,
        mock_build_record,
        mock_populate_hashes,
        mock_extract_spans,
        mock_classify,
        mock_db,
        mock_find_root,
        mock_iter_files,
        capsys,
        caplog,
    ):
        # Setup
        mock_root = Path("/tmp/mock_repo")
        mock_find_root.return_value = mock_root
        # mock_root.name = "mock_repo" # Removed
    
        # Mock files
        mock_iter_files.return_value = [Path("DOCS/API.md"), Path("src/main.py")]
    
        # Mock config
        mock_get_default_domain.return_value = "tech_docs"
        mock_get_path_overrides.return_value = {"DOCS/**": "tech_docs", "*.py": "code"}
    
        # Mock file reading (absolute path)
        with patch("pathlib.Path.read_bytes", return_value=b"content") as mock_read:
            with patch("pathlib.Path.stat") as mock_stat:
                mock_stat.return_value.st_size = 100
                mock_stat.return_value.st_mtime = 1000.0
    
                # Mock DB
                db_instance = mock_db.return_value
                db_instance.get_file_hash.return_value = "old_hash"  # Force update
    
                # Mock extract
                mock_extract_spans.return_value = [MagicMock()]
    
                # Run index_repo with flag
                with caplog.at_level(logging.INFO):
>                   indexer.index_repo(show_domain_decisions=True, export_json=False)

/home/vmlinux/src/llmc/tests/rag/test_indexer_domain_logic.py:63: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/home/vmlinux/src/llmc/llmc/rag/indexer.py:288: in index_repo
    domain, reason_type, reason_detail = resolve_domain(
/home/vmlinux/src/llmc/llmc/rag/routing.py:19: in resolve_domain
    overrides = get_path_overrides(repo_root)
                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/home/vmlinux/src/llmc/llmc/rag/config.py:717: in get_path_overrides
    cfg = load_config(repo_root)
          ^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

repo_root = PosixPath('/tmp/mock_repo')

    def load_config(repo_root: Path | None = None) -> dict[str, Any]:
        """
        Load llmc.toml from the repository root.
        """
        if repo_root is None:
            repo_root = find_repo_root()
    
        config_path = repo_root / "llmc.toml"
        if not config_path.exists():
            return {}
    
>       with open(config_path, "rb") as f:
             ^^^^^^^^^^^^^^^^^^^^^^^
E       FileNotFoundError: [Errno 2] No such file or directory: '/tmp/mock_repo/llmc.toml'

/home/vmlinux/src/llmc/llmc/core.py:36: FileNotFoundError
=========================== short test summary info ============================
SKIPPED [1] tests/rag/ci/test_llmc_docs_validation.py:79: roadmap.md not found
SKIPPED [1] tests/rag/ci/test_llmc_docs_validation.py:112: roadmap.md not found
FAILED tests/rag/test_indexer_domain_logic.py::test_index_repo_domain_logging
1 failed, 121 passed, 2 skipped in 6.65s
