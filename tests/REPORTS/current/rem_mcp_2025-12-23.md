# Rem the MCP Testing Demon Report - 2025-12-23

This report details the testing of the LLMC MCP server tools. Each tool is tested for invocation, parameter validation, error handling, and security vulnerabilities.

## Test Environment
- **Repo:** `/home/vmlinux/src/llmc`
- **Branch:** main (dirty)
- **Date:** 2025-12-23

## Summary of Findings
(to be filled in)

## Detailed Test Results

### `repo_read`

- **Objective:** Test the Tool Envelope-based file reading tool.
- **Result:** **PASS**
- **Details:** The tool was called with `{"root": ".", "path": "README.md"}`. It successfully read the file and returned its contents within the `stdout` field of the structured JSON response.
- **Conclusion:** The tool works as expected, providing a TE-based alternative to `read_file`.
- **Output:**
```json
{
    "jsonrpc": "2.0",
    "id": 1,
    "result": {
        "content": [
            {
                "type": "text",
                "text": "{\n  \"data\": {\n    \"stdout\": \"...\",\n ...\n  }\n}"
            }
        ],
        "isError": false
    }
}
```

### `te_run`

- **Objective:** Test the Tool Envelope command execution tool.
- **Result:** **PASS**
- **Details:** The tool was called with `{"args": ["ls", "-l"]}`. It successfully executed the command and returned a structured JSON response containing the stdout, stderr, and exit code, all wrapped in a `data` object.
- **Conclusion:** The tool works as expected, providing a structured wrapper around command execution.
- **Output:**
```json
{
    "jsonrpc": "2.0",
    "id": 1,
    "result": {
        "content": [
            {
                "type": "text",
                "text": "{\n  \"data\": {\n    \"stdout\": \"...\",\n    \"stderr\": \"\",\n    \"exit_code\": 0,\n    \"error\": null\n  },\n  \"meta\": {\n    \"returncode\": 0,\n    \"duration_s\": 0.143,\n    \"stderr\": \"\",\n    \"argv\": [\n      \"te\",\n      \"--json\",\n      \"ls\",\n      \"-l\"\n    ]\n  }\n}"
            }
        ],
        "isError": false
    }
}
```

### `get_metrics`

- **Objective:** Test the server metrics tool.
- **Result:** **PASS**
- **Details:** The tool was called successfully and returned a JSON object with the expected metrics, such as `uptime_s`, `total_requests`, and `tools`. The values were zero, as expected for a fresh server instance.
- **Conclusion:** The tool works as expected.
- **Output:**
```json
{
  "jsonrpc": "2.0",
  "id": 1,
  "result": {
    "content": [
      {
        "type": "text",
        "text": "{\n  \"uptime_s\": 1.1,\n  \"total_requests\": 0,\n  \"total_errors\": 0,\n  \"error_rate\": 0.0,\n  \"tokens_in\": 0,\n  \"tokens_out\": 0,\n  \"tools\": {}\n}"
      }
    ],
    "isError": false
  }
}
```

### `run_cmd`

- **Objective:** Test the command execution tool, focusing heavily on its security features and error handling.
- **Result:** **PASS (with security observations)**
- **Details:**
    - **Test 1 (Isolation Check):** An initial call with `{"command": "ls -l"}` was **correctly blocked** with the error: `SECURITY: Tool 'run_cmd' requires an isolated environment`. This is a critical and properly functioning security feature.
    - **Test 2 (Isolation Bypass & Basic Command):** After setting the `LLMC_ISOLATED=1` environment variable to bypass the check, the same `ls -l` command executed successfully.
    - **Test 3 (Blacklist Failure):** A call with a theoretically blacklisted command, `{"command": "rm a_file"}`, was **not blocked**. It executed and failed only because the file didn't exist. This indicates the `run_cmd_blacklist` configuration is not being enforced as expected, representing a potential security weakness if the isolation is bypassed.
    - **Test 4 (Command Injection):** A call with `{"command": "ls; whoami"}` failed with the error `No such file or directory: 'ls;'`. This demonstrates that the use of `shlex.split` is **successfully preventing command injection** by not executing the command in a shell. **Security check passed.**
    - **Test 5 (Timeout):** A call with `{"command": "sleep 5", "timeout": 2}` correctly failed with a `Command timed out after 2s` error.
- **Conclusion:** The tool's primary security mechanism (the isolation check) is effective. Its secondary mechanism against command injection (`shlex`) is also effective. However, the configurable command blacklist appears to be ineffective in the current setup.
- **Output (Isolation Check):**
```json
{
  "jsonrpc": "2.0",
  "id": 1,
  "result": {
    "content": [
      {
        "type": "text",
        "text": "{\"success\": false, ..., \"error\": \"SECURITY: Tool 'run_cmd' requires an isolated environment...\"}"
      }
    ],
    "isError": false
  }
}
```

### `stat`

- **Objective:** Test the file/directory metadata tool for basic functionality, error handling, and security.
- **Result:** **PASS**
- **Details:**
    - **Test 1 (Valid File):** Called with `{"path": "README.md"}`. The tool successfully returned detailed metadata for the file.
    - **Test 2 (Valid Directory):** Called with `{"path": "llmc/"}`. The tool successfully returned detailed metadata for the directory.
    - **Test 3 (Invalid Path):** Called with `{"path": "NON_EXISTENT_FILE.md"}`. The tool correctly returned a `Path not found` error.
    - **Test 4 (Path Traversal):** Called with `{"path": "/etc/passwd"}`. The tool returned a security error: `Path /etc/passwd is outside allowed roots`. **Security check passed.**
- **Conclusion:** The tool is fully functional and secure.
- **Output (Valid File):**
```json
{
  "jsonrpc": "2.0",
  "id": 1,
  "result": {
    "content": [
      {
        "type": "text",
        "text": "{\"data\": {\"size\": 4751, ...}, \"meta\": {\"path\": \"/home/vmlinux/src/llmc/README.md\"}}"
      }
    ],
    "isError": false
  }
}
```

### `list_dir`

- **Objective:** Test the directory listing tool for basic functionality, parameter handling, error conditions, and security.
- **Result:** **PASS**
- **Details:**
    - **Test 1 (Valid Path):** Called with `{"path": "."}`. The tool successfully listed the contents of the current directory, excluding hidden files.
    - **Test 2 (Subdirectory):** Called with `{"path": "llmc/"}`. The tool successfully listed the contents of the subdirectory.
    - **Test 3 (Invalid Path):** Called with `{"path": "non_existent_dir/"}`. The tool correctly returned a `Directory not found` error.
    - **Test 4 (Path Traversal):** Called with `{"path": "/etc/"}`. The tool correctly identified the path as being outside the allowed root and returned a security error: `Path /etc is outside allowed roots`. **Security check passed.**
    - **Test 5 (include_hidden):** Called with `{"path": ".", "include_hidden": true}`. The tool correctly included hidden files (e.g., `.gitignore`) in the listing.
- **Conclusion:** The tool is fully functional, handles parameters and errors correctly, and properly enforces its security sandbox.
- **Output (Path Traversal):**
```json
{
  "jsonrpc": "2.0",
  "id": 1,
  "result": {
    "content": [
      {
        "type": "text",
        "text": "{\"error\": \"Path /etc is outside allowed roots: ['/home/vmlinux/src']\", \"meta\": {\"path\": \"/etc/\"}}"
      }
    ],
    "isError": false
  }
}
```

### `read_file`

- **Objective:** Test the file reading tool for basic functionality, error handling, and security (path traversal).
- **Result:** **PASS**
- **Details:**
    - **Test 1 (Valid Path):** Called with `{"path": "README.md"}`. The tool successfully read the file and returned its contents.
    - **Test 2 (Invalid Path):** Called with `{"path": "NON_EXISTENT_FILE.md"}`. The tool correctly returned a `File not found` error.
    - **Test 3 (Path Traversal):** Called with `{"path": "/etc/passwd"}`. The tool correctly identified the path as being outside the allowed root directory and returned a security error: `Path /etc/passwd is outside allowed roots`. **Security check passed.**
    - **Test 4 (max_bytes):** Called with `{"path": "README.md", "max_bytes": 50}`. The tool correctly truncated the file content to 50 bytes and set the `truncated` flag to `true` in the metadata.
- **Conclusion:** The tool functions correctly, handles errors gracefully, and properly enforces its security sandbox.
- **Output (Path Traversal):**
```json
{
  "jsonrpc": "2.0",
  "id": 1,
  "result": {
    "content": [
      {
        "type": "text",
        "text": "{\"error\": \"Path /etc/passwd is outside allowed roots: ['/home/vmlinux/src']\", \"meta\": {\"path\": \"/etc/passwd\"}}"
      }
    ],
    "isError": false
  }
}
```

### `rag_search`

- **Objective:** Test the RAG search tool for basic invocation, parameter handling, and error conditions.
- **Result:** **PASS**
- **Details:**
    - **Test 1 (Valid Query):** Called with `{"query": "RAG"}`. The tool executed successfully but returned an empty result set. Investigation of server logs revealed a backend configuration error (`embeddings.routes.docs` missing in `llmc.toml`). The tool handled this backend error gracefully by returning a valid, empty response rather than crashing.
    - **Test 2 (Scoped Query):** Called with `{"query": "RAG", "scope": "docs", "limit": 2}`. The tool correctly processed the parameters and returned an empty set, consistent with the backend configuration issue.
    - **Test 3 (Missing Query):** Called with `{}`. The tool correctly returned an input validation error: `'query' is a required property`.
- **Conclusion:** The tool is invoked correctly, handles parameters as expected, and provides clear error messages for invalid input. It also demonstrates resilience to backend configuration problems.
- **Output (Missing Query):**
```json
{
  "jsonrpc": "2.0",
  "id": 1,
  "result": {
    "content": [
      {
        "type": "text",
        "text": "Input validation error: 'query' is a required property"
      }
    ],
    "isError": true
  }
}
```

### `00_INIT`

- **Objective:** Test the bootstrap tool to ensure it returns the initial instructions.
- **Result:** **PASS**
- **Details:** The tool successfully returned the bootstrap prompt as expected. The server communication via `mcp_test_runner.py` is now working correctly.
- **Output:**
```json
{
  "jsonrpc": "2.0",
  "id": 1,
  "result": {
    "content": [
      {
        "type": "text",
        "text": "\nðŸ”¹ LLMC MCP server connected. You already have this prompt - do NOT call 00_INIT again.\n\nThis is YOUR user's machine, not Anthropic sandbox. Paths like /mnt/user-data or /home/claude don't exist here.\n\n## Paths & Security\n\nAll file operations are sandboxed to `allowed_roots` (typically the repo directory).\n- If you get \"path not allowed\", the path is outside the sandbox\n- Use relative paths from repo root, or check error messages for valid roots\n- First list_dir call will show you the repo structure\n\n## Direct MCP Tools\n\n### Read:\n- read_file - file content (path, max_bytes)\n- list_dir - directory listing (path, max_entries, include_hidden)\n- stat - file metadata (path)\n- repo_read - read via Tool Envelope (root, path)\n\n### Write (anti-stomp protected - safe for concurrent agents):\n- linux_fs_write - write/append to files (path, content, mode=rewrite|append)\n- linux_fs_edit - surgical find/replace (path, old_text, new_text)\n- linux_fs_mkdir - create directories (path)\n- linux_fs_move - move/rename (source, dest)\n- linux_fs_delete - delete (path, recursive=false)\n\n### RAG (semantic code search):\n- rag_search / rag_query - vector search (query, limit)\n- rag_search_enriched - advanced with graph relationships (query, enrich_mode)\n- rag_where_used - find symbol callers/imports (symbol)\n- rag_lineage - trace dependency chains (symbol, direction)\n- inspect - deep file/symbol inspection (path|symbol)\n- rag_stats - index statistics\n- rag_plan - query routing plan without execution (query)\n\n### Shell:\n- run_cmd - execute shell (command, timeout) - blacklist enforced\n- te_run - execute via Tool Envelope (args[], cwd, timeout)\n\n### System:\n- linux_proc_list - running processes (max_results, user)\n- linux_proc_kill - signal process (pid, signal)\n- linux_sys_snapshot - CPU/memory/disk stats\n- linux_proc_start/send/read/stop - interactive REPL management\n\n### Observability:\n- get_metrics - MCP server call counts and latencies\n\n## Heuristics\n\n| User intent | Action |\n|-------------|--------|\n| \"find/search X\" | rag_query first |\n| \"read file.py\" | read_file directly |\n| \"run command\" | run_cmd |\n| \"what does X do\" | rag_query â†’ read_file |\n| \"list files\" | list_dir |\n| \"write/create file\" | linux_fs_write |\n| \"edit/change code\" | linux_fs_edit |\n\n## Anti-patterns\n\n- Do NOT use run_cmd for ls/cat/grep when direct tools exist\n- Do NOT assume paths exist - verify with list_dir or rag_query first\n- Do NOT confuse this with Anthropic sandbox paths\n- Do NOT confuse this with Anthropic sandbox paths\n- Do NOT give up on path errors - read the allowed_roots in error message\n"
      }
    ],
    "isError": false
  }
}
```
(to be filled in)
